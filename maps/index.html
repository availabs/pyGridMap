
<!DOCTYPE html>
<html>
<head>
	<title>Grid Map</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
	<link rel="stylesheet" href="styles/custom.css" />
</head>
<body>
	<div id="map"></div>

	<script src="bower_components/leaflet/dist/leaflet.js"></script>
	<script src="bower_components/d3/d3.js"></script>
	<script src="js/src/generateGrid.js"></script>
	<script>

	(function(console){

console.save = function(data, filename){

    if(!data) {
        console.error('Console.save: No data')
        return;
    }

    if(!filename) filename = 'console.json'

    if(typeof data === "object"){
        data = JSON.stringify(data, undefined, 4)
    }

    var blob = new Blob([data], {type: 'text/json'}),
        e    = document.createEvent('MouseEvents'),
        a    = document.createElement('a')

    a.download = filename
    a.href = window.URL.createObjectURL(blob)
    a.dataset.downloadurl =  ['text/json', a.download, a.href].join(':')
    e.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null)
    a.dispatchEvent(e)
 }
})(console)

	var map = L.map('map')
		.setView([0, 180], 2); // lat/lon/zoom

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6IjZjNmRjNzk3ZmE2MTcwOTEwMGY0MzU3YjUzOWFmNWZhIn0.Y8bhBaUMqFiPrDRW9hieoQ', {
		maxZoom: 18,
		id: 'mapbox.streets',
		bounds:[[-85.0, 0.0],[85.0, 360.0]],
		noWrap:true
	}).addTo(map);

	var grid = generateGrid(); // generate mapping grid

	d3.json('http://localhost:5000/grids/5',function(err,data){
		console.log('some data',data,err)

		// Initialize mapping variables
		var lats = [], // latitude coordinates
		lngs = [], // longitude coordinates
		values = [], // values
		valueObj = {} //

		data.forEach(function(d){

			if(!valueObj[d[1]]){
				valueObj[d[1]] = {}
			}

			valueObj[d[1]][d[2]] = d[3]

			if(d[3] != -999){
				values.push(d[3])
			}
		})

		var datascale = d3.scale.quantile(); // scale colors by value
		datascale
		.domain([0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110]) // subset bounds
		.range(["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c",
		"#fc4e2a","#e31a1c","#bd0026","#800026","#000000","#ffffff"]) // fill colors

		console.log('data scale', datascale)
		grid.features = grid.features.filter(function(d){
			return valueObj[d.properties.lat][d.properties.lng] > 0;
		}).map(function(d){
			d.properties.color= datascale(valueObj[d.properties.lat][d.properties.lng])
			return d;
		});
		console.save(grid);
		var gridLayer = L.geoJson(grid,{

			style:function(feature){ // init styling

				var gridValue = valueObj[feature.properties.lat][feature.properties.lng], // value to map
					color = '#fff',
					opacity = 0.5;

				if(gridValue > 0 ){
					color = datascale(gridValue);
				}else{
					opacity = 0; // Boxes with no data are transparent
				}

				return {
					stroke:false, // no grid box boundaries
					fill:true, // fill boxes
					fillOpacity:opacity, //set box opacity
					color:color // fill/boundary color
				}
			},
			onEachFeature:function(feature, layer){ // interactive styling

				layer.on({

					mouseover:function(e){

						var gridValue = valueObj[feature.properties.lat][feature.properties.lng] // value to map
						var color = [];

						if(gridValue > 0 ){
							color = datascale(gridValue)
						}

						console.log('mouseover',color,gridValue,feature.properties.lat,feature.properties.lng);

						layer.setStyle({
							stroke:true, // grid box boundaries on
							weight:5 // grid box boundary weight
						});
					},

					mouseout:function(e){

						layer.setStyle({
							stroke:false // grid box boundaries off
						});
					}
				})

			}
		});

		gridLayer.addTo(map);

	})


	</script>
</body>
</html>
